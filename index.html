<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix AI Training Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f8f8;
      --card-bg: #ffffff;
      --text-primary: #000000;
      --text-secondary: #666666;
      --border: #e0e0e0;
      --accent: #d40000;
      --bbm-red: #d40000;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --glow: 0 0 10px rgba(212, 0, 0, 0.3);
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    .header {
      background: var(--card-bg);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--border);
    }
    .header h1 {
      font-family: 'Orbitron', monospace;
      color: var(--bbm-red);
      font-weight: 900;
      font-size: 28px;
      letter-spacing: 0.5px;
      text-shadow: 0 0 10px rgba(212, 0, 0, 0.3);
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .add-form, .bulk-form {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: end;
    }
    .add-form input {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 16px;
    }
    .bulk-form {
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
    }
    .bulk-form input[type="file"] {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
    }
    .bulk-form textarea {
      flex: 1;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      resize: vertical;
      font-family: monospace;
    }
    .bulk-preview {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .btn {
      background: var(--bbm-red);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn:hover {
      background: #b30000;
      box-shadow: var(--glow);
    }
    .btn-danger {
      background: #ff4444;
    }
    .btn-danger:hover {
      background: #cc0000;
    }
    .btn-secondary {
      background: #6b7280;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
    .training-pair {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .training-pair input {
      flex: 1;
      min-width: 150px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
    }
    .pair-actions {
      display: flex;
      gap: 8px;
    }
    .stats {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      color: var(--text-secondary);
    }
    .loading {
      text-align: center;
      padding: 40px;
      font-style: italic;
      color: var(--text-secondary);
    }
    .error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 6px;
      margin: 20px 0;
      border-left: 4px solid #c33;
    }
    .success {
      background: #efe;
      color: #080;
      padding: 12px;
      border-radius: 6px;
      margin: 20px 0;
      border-left: 4px solid #080;
    }
    .hidden {
      display: none !important;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: var(--bbm-red);
      transition: width 0.3s ease;
      width: 0%;
    }
    .ai-training-section {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
    }
    .ai-training-section button {
      margin-top: 10px;
    }
    #model-status {
      margin-top: 10px;
      font-style: italic;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Vynix AI Training Dashboard</h1>
    <p>Manage training data for your AI companion</p>
  </header>

  <div class="container">
    <div id="auth-status" class="stats">Loading...</div>
    <div id="stats" class="stats hidden">Total pairs: <span id="pair-count">0</span></div>

    <div id="error-message" class="error hidden"></div>
    <div id="success-message" class="success hidden"></div>

    <form id="add-form" class="add-form hidden">
      <input type="text" id="new-q" placeholder="Question (e.g., 'hello')" required>
      <input type="text" id="new-a" placeholder="Answer (e.g., 'Hi! What's up?')" required>
      <button type="submit" class="btn">Add Pair</button>
    </form>

    <form id="bulk-form" class="bulk-form hidden">
      <div>
        <label for="bulk-input" class="block text-sm font-medium text-gray-700 mb-2">Bulk Upload Options</label>
        <div class="flex gap-4 mb-4">
          <label class="flex items-center">
            <input type="radio" name="bulk-mode" value="csv" checked class="mr-2">
            CSV File (q,a per line)
          </label>
          <label class="flex items-center">
            <input type="radio" name="bulk-mode" value="text" class="mr-2">
            Text (q|a per line)
          </label>
        </div>
      </div>
      <input type="file" id="bulk-input" accept=".csv,.txt" placeholder="Upload CSV or TXT file">
      <textarea id="bulk-text" placeholder="Or paste bulk data here (one pair per line: question|answer)" style="display: none;"></textarea>
      <div id="bulk-preview" class="bulk-preview hidden">Preview will appear here...</div>
      <div class="progress-bar hidden">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
      <button type="submit" class="btn" id="bulk-submit" disabled>Bulk Add Pairs</button>
    </form>

    <div id="loading" class="loading">Loading training data...</div>
    <div id="pairs-list"></div>

    <button id="retrain-btn" class="btn hidden" style="display: block; margin: 20px auto;">Trigger Retrain (Saves & Notifies)</button>

    <div id="ai-training-section" class="ai-training-section hidden">
      <h3>AI Model Training (Brain.js)</h3>
      <p>Train a local neural network on your Q&A data for client-side predictions.</p>
      <button id="train-model-btn" class="btn">Train Model</button>
      <button id="test-model-btn" class="btn btn-secondary" disabled>Test Prediction</button>
      <div id="model-status"></div>
      <input type="text" id="test-input" placeholder="Enter a test question..." style="margin-top: 10px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; width: 100%;">
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import brain from 'https://cdn.skypack.dev/brain.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const elements = {
      authStatus: document.getElementById('auth-status'),
      stats: document.getElementById('stats'),
      pairCount: document.getElementById('pair-count'),
      errorMessage: document.getElementById('error-message'),
      successMessage: document.getElementById('success-message'),
      addForm: document.getElementById('add-form'),
      newQ: document.getElementById('new-q'),
      newA: document.getElementById('new-a'),
      bulkForm: document.getElementById('bulk-form'),
      bulkInput: document.getElementById('bulk-input'),
      bulkText: document.getElementById('bulk-text'),
      bulkPreview: document.getElementById('bulk-preview'),
      bulkSubmit: document.getElementById('bulk-submit'),
      progressFill: document.getElementById('progress-fill'),
      loading: document.getElementById('loading'),
      pairsList: document.getElementById('pairs-list'),
      retrainBtn: document.getElementById('retrain-btn'),
      aiTrainingSection: document.getElementById('ai-training-section'),
      trainModelBtn: document.getElementById('train-model-btn'),
      testModelBtn: document.getElementById('test-model-btn'),
      modelStatus: document.getElementById('model-status'),
      testInput: document.getElementById('test-input')
    };

    let currentUser;
    let trainingData = {};
    let dataKeys = [];
    let net;  // Brain.js network
    let wordToIdx = {};
    let idxToWord = {};
    let vocab = new Set();

    function showError(msg) {
      elements.errorMessage.textContent = msg;
      elements.errorMessage.classList.remove('hidden');
      elements.successMessage.classList.add('hidden');
    }

    function showSuccess(msg) {
      elements.successMessage.textContent = msg;
      elements.successMessage.classList.remove('hidden');
      elements.errorMessage.classList.add('hidden');
    }

    function hideMessages() {
      elements.errorMessage.classList.add('hidden');
      elements.successMessage.classList.add('hidden');
    }

    function updateStats() {
      elements.pairCount.textContent = Object.keys(trainingData).length;
      elements.stats.classList.remove('hidden');
    }

    function renderPairs() {
      elements.pairsList.innerHTML = '';
      dataKeys.forEach(key => {
        const pair = trainingData[key];
        if (!pair || !pair.q || !pair.a) return;

        const pairDiv = document.createElement('div');
        pairDiv.className = 'training-pair';
        pairDiv.innerHTML = `
          <input type="text" value="${pair.q}" data-key="${key}" data-field="q" placeholder="Question">
          <input type="text" value="${pair.a}" data-key="${key}" data-field="a" placeholder="Answer">
          <div class="pair-actions">
            <button class="btn" onclick="updatePair('${key}')">Update</button>
            <button class="btn btn-danger" onclick="deletePair('${key}')">Delete</button>
          </div>
        `;
        elements.pairsList.appendChild(pairDiv);
      });
      updateStats();
    }

    async function addPair(q, a) {
      if (!currentUser || !q.trim() || !a.trim()) {
        throw new Error('Please log in and enter both question and answer.');
      }
      const trainingRef = ref(db, 'training_data');
      const newPairRef = push(trainingRef);
      const newPair = { q: q.trim().toLowerCase(), a: a.trim(), timestamp: Date.now() };
      await set(newPairRef, newPair);
      return newPair;
    }

    window.updatePair = async function(key) {
      if (!currentUser) return;
      const inputs = document.querySelectorAll(`[data-key="${key}"]`);
      const qInput = inputs[0].value.trim().toLowerCase();
      const aInput = inputs[1].value.trim();
      if (!qInput || !aInput) {
        showError('Question and answer cannot be empty.');
        return;
      }
      try {
        hideMessages();
        const pairRef = ref(db, `training_data/${key}`);
        await update(pairRef, { q: qInput, a: aInput, timestamp: Date.now() });
        showSuccess('Pair updated successfully!');
        console.log('Updated pair:', { key, q: qInput, a: aInput });
      } catch (error) {
        showError('Failed to update pair: ' + error.message);
        console.error('Update pair error:', error);
      }
    };

    window.deletePair = async function(key) {
      if (!currentUser) return;
      if (!confirm('Delete this training pair?')) return;
      try {
        hideMessages();
        const pairRef = ref(db, `training_data/${key}`);
        await remove(pairRef);
        showSuccess('Pair deleted successfully!');
        console.log('Deleted pair:', key);
      } catch (error) {
        showError('Failed to delete pair: ' + error.message);
        console.error('Delete pair error:', error);
      }
    };

    async function triggerRetrain() {
      showSuccess('Training data saved! Vynix will retrain automatically in connected apps.');
    }

    function loadTrainingData() {
      const trainingRef = ref(db, 'training_data');
      onValue(trainingRef, (snapshot) => {
        const data = snapshot.val();
        trainingData = data || {};
        dataKeys = Object.keys(trainingData);
        renderPairs();
        elements.loading.classList.add('hidden');
        if (currentUser && dataKeys.length > 0) {
          elements.aiTrainingSection.classList.remove('hidden');
        }
      }, (error) => {
        showError('Failed to load training data: ' + error.message);
        elements.loading.classList.add('hidden');
        console.error('Load data error:', error);
      });
    }

    // Bulk functionality
    function parseBulkData(content, mode) {
      let lines;
      if (mode === 'csv') {
        lines = content.split('\n').slice(1).filter(line => line.trim());
        return lines.map(line => {
          const [q, a] = line.split(',').map(s => s.trim().replace(/"/g, ''));
          return { q, a };
        }).filter(pair => pair.q && pair.a);
      } else {
        lines = content.split('\n').filter(line => line.trim());
        return lines.map(line => {
          const [q, a] = line.split('|').map(s => s.trim());
          return { q, a };
        }).filter(pair => pair.q && pair.a);
      }
    }

    function updateBulkPreview(pairs) {
      if (pairs.length === 0) {
        elements.bulkPreview.textContent = 'No valid pairs found.';
        elements.bulkSubmit.disabled = true;
      } else {
        elements.bulkPreview.textContent = `${pairs.length} valid pairs parsed:\n\n${pairs.slice(0, 10).map(p => `${p.q} | ${p.a}`).join('\n')}${pairs.length > 10 ? '\n\n... (showing first 10)' : ''}`;
        elements.bulkSubmit.disabled = false;
      }
      elements.bulkPreview.classList.remove('hidden');
    }

    async function handleBulkSubmit(e) {
      e.preventDefault();
      const mode = document.querySelector('input[name="bulk-mode"]:checked').value;
      let content = '';

      if (mode === 'text') {
        content = elements.bulkText.value;
      } else {
        const file = elements.bulkInput.files[0];
        if (!file) {
          showError('Please select a file.');
          return;
        }
        const text = await file.text();
        content = text;
      }

      const pairs = parseBulkData(content, mode);
      if (pairs.length === 0) {
        showError('No valid pairs found in the input.');
        return;
      }

      const progressBar = elements.progressFill.parentElement;
      progressBar.classList.remove('hidden');
      hideMessages();

      let added = 0;
      let errors = 0;
      for (let i = 0; i < pairs.length; i++) {
        try {
          await addPair(pairs[i].q, pairs[i].a);
          added++;
        } catch (error) {
          errors++;
          console.error(`Failed to add pair ${i + 1}:`, error);
        }
        const progress = ((i + 1) / pairs.length) * 100;
        elements.progressFill.style.width = `${progress}%`;
      }

      progressBar.classList.add('hidden');
      elements.progressFill.style.width = '0%';

      if (added > 0) {
        showSuccess(`Bulk upload complete: ${added} pairs added, ${errors} errors.`);
        if (mode === 'text') {
          elements.bulkText.value = '';
        } else {
          elements.bulkInput.value = '';
        }
        elements.bulkPreview.classList.add('hidden');
      } else {
        showError('Bulk upload failed: No pairs added.');
      }
    }

    // Brain.js Training
    async function trainBrainJS() {
      if (!currentUser || Object.keys(trainingData).length === 0) {
        showError('No data to train on. Add some Q&A pairs first.');
        return;
      }

      elements.trainModelBtn.disabled = true;
      elements.modelStatus.textContent = 'Training model... (This may take a moment)';
      hideMessages();

      try {
        // Preprocess data
        vocab.clear();
        const trainingSet = dataKeys.map(key => {
          const q = trainingData[key].q.toLowerCase().split(' ').slice(0, 10);
          const a = trainingData[key].a.toLowerCase().split(' ').slice(0, 20);
          q.forEach(word => vocab.add(word));
          a.forEach(word => vocab.add(word));
          return { input: q, output: a };
        });

        wordToIdx = Array.from(vocab).reduce((acc, word, i) => { acc[word] = i; return acc; }, {});
        idxToWord = Object.fromEntries(Object.entries(wordToIdx).map(([k, v]) => [v, k]));

        const processedData = trainingSet.map(item => ({
          input: item.input.map(word => [(wordToIdx[word] || 0) / vocab.size]),
          output: item.output.map(word => [(wordToIdx[word] || 0) / vocab.size])
        }));

        // Train LSTM
        net = new brain.recurrent.LSTMTimeStep({
          inputSize: 1,
          hiddenLayers: [10],
          outputSize: 1
        });

        net.train(processedData, {
          iterations: 200,
          errorThresh: 0.005,
          log: true,
          logPeriod: 50
        });

        // Export model (e.g., to localStorage for chat app use)
        const modelJson = net.toJSON();
        localStorage.setItem('vynix-brain-model', JSON.stringify(modelJson));
        localStorage.setItem('vynix-vocab', JSON.stringify({ wordToIdx, idxToWord }));

        elements.modelStatus.textContent = `Model trained on ${processedData.length} pairs! Ready for predictions.`;
        elements.testModelBtn.disabled = false;
        showSuccess('Brain.js model trained successfully!');
        console.log('Trained model exported to localStorage.');
      } catch (error) {
        showError('Training failed: ' + error.message);
        elements.modelStatus.textContent = 'Training failed.';
        console.error('Training error:', error);
      } finally {
        elements.trainModelBtn.disabled = false;
      }
    }

    function predictResponse(question) {
      if (!net) {
        showError('No trained model. Train first.');
        return;
      }
      try {
        const inputSeq = question.toLowerCase().split(' ').slice(0, 10).map(word => [(wordToIdx[word] || 0) / vocab.size]);
        const outputSeq = net.run(inputSeq);
        const words = outputSeq.map(val => idxToWord[Math.round(val * vocab.size)] || '').filter(Boolean).join(' ');
        const response = words.charAt(0).toUpperCase() + words.slice(1) + '.';
        elements.modelStatus.textContent = `Prediction: ${response}`;
        return response;
      } catch (error) {
        showError('Prediction failed: ' + error.message);
        console.error('Prediction error:', error);
      }
    }

    // Event listeners
    elements.addForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const q = elements.newQ.value;
      const a = elements.newA.value;
      addPair(q, a).then(() => {
        elements.newQ.value = '';
        elements.newA.value = '';
        showSuccess('Pair added successfully!');
      }).catch(error => {
        showError(error.message);
      });
    });

    elements.retrainBtn.addEventListener('click', triggerRetrain);

    elements.bulkForm.addEventListener('submit', handleBulkSubmit);

    const modeRadios = document.querySelectorAll('input[name="bulk-mode"]');
    modeRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        const isText = e.target.value === 'text';
        elements.bulkInput.style.display = isText ? 'none' : 'block';
        elements.bulkText.style.display = isText ? 'block' : 'none';
        elements.bulkPreview.classList.add('hidden');
        elements.bulkSubmit.disabled = true;
      });
    });

    elements.bulkInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const content = await file.text();
      const pairs = parseBulkData(content, 'csv');
      updateBulkPreview(pairs);
    });

    elements.bulkText.addEventListener('input', (e) => {
      const content = e.target.value;
      const pairs = parseBulkData(content, 'text');
      updateBulkPreview(pairs);
    });

    elements.trainModelBtn.addEventListener('click', trainBrainJS);

    elements.testModelBtn.addEventListener('click', () => {
      const question = elements.testInput.value.trim();
      if (!question) {
        showError('Enter a test question.');
        return;
      }
      predictResponse(question);
    });

    elements.testInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        elements.testModelBtn.click();
      }
    });

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        elements.authStatus.innerHTML = `Logged in as: ${user.displayName || user.email || 'User'} <button class="btn btn-secondary" onclick="signOutUser()" style="font-size: 12px; padding: 4px 8px; margin-left: 10px;">Sign Out</button>`;
        elements.addForm.classList.remove('hidden');
        elements.bulkForm.classList.remove('hidden');
        elements.retrainBtn.classList.remove('hidden');
        loadTrainingData();
      } else {
        elements.authStatus.innerHTML = 'Not logged in. <button class="btn" onclick="signInAnonymously()">Sign In Anonymously</button>';
        elements.addForm.classList.add('hidden');
        elements.bulkForm.classList.add('hidden');
        elements.retrainBtn.classList.add('hidden');
        elements.aiTrainingSection.classList.add('hidden');
        elements.pairsList.innerHTML = '<p class="loading">Please sign in to manage training data.</p>';
        elements.loading.classList.add('hidden');
      }
    });

    window.signInAnonymously = async function() {
      try {
        await signInAnonymously(auth);
      } catch (error) {
        showError('Sign in failed: ' + error.message);
      }
    };

    window.signOutUser = async function() {
      try {
        await signOut(auth);
      } catch (error) {
        showError('Sign out failed: ' + error.message);
      }
    };

    // Initial load
    elements.loading.classList.remove('hidden');
  </script>
</body>
</html>
