<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vynix AI - Dashboard & Training</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/brain.js@2.0.0-beta.2/dist/brain-browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #F7F7F8; margin: 0; }
    .header { position: fixed; top: 0; left: 0; right: 0; padding: 1rem; display: flex; justify-content: center; align-items: center; background: white; border-bottom: 1px solid #e5e7eb; z-index: 10; }
    .v-logo { width: 40px; height: 40px; background: #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .v-logo svg { width: 24px; height: 24px; fill: white; }
    .content { margin-top: 6rem; padding: 2rem; max-width: 1000px; margin-left: auto; margin-right: auto; }
    .card { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .input-field { width: 100%; padding: 1rem 1.25rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 1rem; font-size: 1rem; }
    .input-field:focus { outline: none; border-color: #000; }
    .btn { padding: 1rem 2rem; border-radius: 9999px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #000, #333); color: white; }
    .btn-primary:hover { transform: scale(1.05); }
    .btn-train { background: linear-gradient(135deg, #7c3aed, #db2777); color: white; }
    .pair-item { background: #f9fafb; border-radius: 1rem; padding: 1.25rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .progress-bar { height: 12px; background: #e5e7eb; border-radius: 999px; overflow: hidden; margin: 1rem 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #7c3aed, #db2777); width: 0%; transition: width 0.3s; }
    .training-status { text-align: center; font-weight: 600; margin: 1rem 0; }
  </style>
</head>
<body>
  <!-- Header with V logo -->
  <div class="header">
    <div class="v-logo">
      <svg viewBox="0 0 24 24">
        <path d="M19.75 2.25h3L12 21.75h-3L1.25 2.25h3l7.5 17.19z"/>
      </svg>
    </div>
  </div>

  <div class="content">
    <div class="card">
      <h1 class="text-3xl font-bold text-center mb-8">Vynix AI Dashboard & Training</h1>

      <!-- Add Response -->
      <div class="mb-12">
        <h2 class="text-2xl font-semibold mb-6">Add Response</h2>
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <input type="text" id="trigger" placeholder="Trigger phrase..." class="input-field">
          <input type="text" id="reply" placeholder="Bot reply..." class="input-field">
        </div>
        <button id="add-single" class="btn btn-primary w-full">Add to Global Brain</button>
      </div>

      <!-- Bulk Import -->
      <div class="mb-12">
        <h2 class="text-2xl font-semibold mb-6">Bulk Import (JSON)</h2>
        <textarea id="bulk-json" class="input-field h-48 font-mono text-sm" placeholder='[{"trigger":"hi","reply":"Hello!"}, ...]'></textarea>
        <button id="bulk-import" class="btn btn-primary w-full mt-4">Import All</button>
        <div id="bulk-status" class="mt-4 text-center font-medium"></div>
      </div>

      <!-- Training Section -->
      <div class="mb-12">
        <h2 class="text-2xl font-semibold mb-6">Train Neural Model (Optional Fallback)</h2>
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <button id="train-lstm" class="btn btn-train p-8 text-left">
            <div class="text-xl font-bold">Standard LSTM</div>
            <div class="text-sm opacity-80 mt-2">Best quality • Slower training</div>
            <div class="text-3xl font-bold mt-4" id="lstm-count">(0 pairs)</div>
          </button>
          <button id="train-turbo" class="btn btn-train p-8 text-left">
            <div class="text-xl font-bold">⚡ Turbo Mode</div>
            <div class="text-sm opacity-80 mt-2">10× faster • Still excellent</div>
            <div class="text-3xl font-bold mt-4" id="turbo-count">(0 pairs)</div>
          </button>
        </div>
        <div id="training-progress" class="hidden">
          <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
          <div class="training-status" id="training-status">Preparing...</div>
        </div>
        <button id="save-model" class="btn btn-primary w-full mt-6" disabled>Save as New Global Brain</button>
      </div>

      <!-- Your Contributions -->
      <div>
        <h2 class="text-2xl font-semibold mb-6">Your Contributions (<span id="my-count">0</span>)</h2>
        <div id="my-pairs" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const el = {
      trigger: document.getElementById('trigger'),
      reply: document.getElementById('reply'),
      addSingle: document.getElementById('add-single'),
      bulkJson: document.getElementById('bulk-json'),
      bulkImport: document.getElementById('bulk-import'),
      bulkStatus: document.getElementById('bulk-status'),
      myPairs: document.getElementById('my-pairs'),
      myCount: document.getElementById('my-count'),
      trainLstm: document.getElementById('train-lstm'),
      trainTurbo: document.getElementById('train-turbo'),
      lstmCount: document.getElementById('lstm-count'),
      turboCount: document.getElementById('turbo-count'),
      trainingProgress: document.getElementById('training-progress'),
      progressFill: document.getElementById('progress-fill'),
      trainingStatus: document.getElementById('training-status'),
      saveModel: document.getElementById('save-model')
    };

    let pairs = [];
    let myUid = null;
    let trainedNet = null;

    // Load all pairs
    onValue(ref(db, 'pairs'), snap => {
      pairs = [];
      const data = snap.val() || {};
      Object.values(data).forEach(p => {
        if (p.trigger && p.reply) pairs.push({ trigger: p.trigger.trim(), reply: p.reply.trim() });
      });
      el.lstmCount.textContent = el.turboCount.textContent = `(${pairs.length} pairs)`;
      renderMyContributions();
    });

    function renderMyContributions() {
      onValue(ref(db, 'pairs'), snap => {
        const data = snap.val() || {};
        const mine = Object.entries(data)
          .filter(([id, p]) => p.uid === myUid)
          .map(([id, p]) => ({id, ...p}));

        el.myCount.textContent = mine.length;

        el.myPairs.innerHTML = mine.map(p => `
          <div class="pair-item">
            <div>
              <div class="font-mono text-sm opacity-70">"${p.trigger}"</div>
              <div class="mt-1">${p.reply}</div>
            </div>
            <button class="bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center" onclick="deletePair('${p.id}')">×</button>
          </div>
        `).join('') || '<p class="text-center text-gray-500 py-8">No contributions yet</p>';
      }, { onlyOnce: true });
    }

    // Add single
    el.addSingle.onclick = async () => {
      const trigger = el.trigger.value.trim().toLowerCase();
      const reply = el.reply.value.trim();
      if (!trigger || !reply) return;

      const newRef = push(ref(db, 'pairs'));
      await set(newRef, {
        trigger,
        reply,
        uid: auth.currentUser.uid,
        addedAt: Date.now()
      });

      el.trigger.value = el.reply.value = '';
    };

    // Bulk import
    el.bulkImport.onclick = async () => {
      try {
        const items = JSON.parse(el.bulkJson.value);
        if (!Array.isArray(items)) throw "Invalid";

        let added = 0;
        for (const item of items) {
          const trigger = String(item.trigger || "").trim().toLowerCase();
          const reply = String(item.reply || "").trim();
          if (trigger && reply) {
            const newRef = push(ref(db, 'pairs'));
            await set(newRef, {
              trigger,
              reply,
              uid: auth.currentUser.uid,
              addedAt: Date.now()
            });
            added++;
          }
        }

        el.bulkJson.value = '';
        el.bulkStatus.textContent = `Added ${added} responses!`;
        el.bulkStatus.style.color = '#10b981';
      } catch (e) {
        el.bulkStatus.textContent = "Invalid JSON";
        el.bulkStatus.style.color = '#ef4444';
      }
    };

    // Training
    let trainingWorker = null;

    function startTraining(turbo = false) {
      if (pairs.length === 0) return alert("No data to train on!");

      el.trainingProgress.classList.remove('hidden');
      el.progressFill.style.width = '0%';
      el.trainingStatus.textContent = turbo ? "Training Turbo model..." : "Training Standard LSTM...";

      const code = `
        importScripts('https://cdn.jsdelivr.net/npm/brain.js@2.0.0-beta.2/dist/brain-browser.min.js');
        const encode = s => s.padEnd(200,' ').slice(0,200).split('').map(c=>c.charCodeAt(0)/255);
        const decode = a => a.map(n=>String.fromCharCode(Math.round(n*255))).join('').trim();
        self.onmessage = e => {
          const data = e.data.pairs;
          const turbo = e.data.turbo;
          const net = turbo ? new brain.NeuralNetwork({hiddenLayers: [512,512,512]}) : new brain.recurrent.LSTM();
          const formatted = turbo ? data.map(p=>({input:encode(p.trigger), output:encode(p.reply)})) : data.map(p=>({input:p.trigger, output:p.reply}));
          net.train(formatted, { 
            iterations: turbo ? 60000 : Math.min(200, data.length * 2),
            log: true, 
            logPeriod: 1000,
            callback: s => self.postMessage({progress: s.iterations / (turbo ? 60000 : Math.min(200, data.length * 2))})
          });
          self.postMessage({done: net.toJSON()});
        };
      `;

      trainingWorker = new Worker(URL.createObjectURL(new Blob([code], {type: 'application/javascript'})));
      trainingWorker.postMessage({pairs, turbo});

      trainingWorker.onmessage = e => {
        if (e.data.progress !== undefined) {
          el.progressFill.style.width = (e.data.progress * 100) + '%';
        }
        if (e.data.done) {
          trainedNet = e.data.done;
          el.trainingStatus.textContent = "Training complete! Ready to save.";
          el.saveModel.disabled = false;
          trainingWorker.terminate();
        }
      };
    }

    el.trainLstm.onclick = () => startTraining(false);
    el.trainTurbo.onclick = () => startTraining(true);

    el.saveModel.onclick = async () => {
      if (!trainedNet) return;
      el.saveModel.disabled = true;
      el.trainingStatus.textContent = "Saving global model...";

      const newRef = push(ref(db, 'global-models'));
      await set(newRef, {
        model: trainedNet,
        pairsUsed: pairs.length,
        timestamp: Date.now(),
        trainer: auth.currentUser.email || "Dashboard"
      });

      el.trainingStatus.textContent = "New global brain saved! Live worldwide.";
      setTimeout(() => {
        el.trainingProgress.classList.add('hidden');
        el.saveModel.disabled = true;
        trainedNet = null;
      }, 3000);
    };

    window.deletePair = (id) => remove(ref(db, `pairs/${id}`));

    onAuthStateChanged(auth, user => {
      if (user) myUid = user.uid;
      else signInAnonymously(auth);
    });
  </script>
</body>
</html>
